<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
			<title>3D Game Design</title>
			<script src="cannon.js"></script>
			<script src="babylon.js"></script>
			<script src="babylon.objFileLoader.min.js"></script>
			<script>

			</script>
			<style>
				html, body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				}
				#renderCanvas {
				width: 100%;
				height: 100%;
				touch-action: none;
				}
			</style>
			<script>
				function start() {
				var canvas = document.getElementById('renderCanvas');
				var engine = new BABYLON.Engine(canvas, true);
				var keys = {};
				window.addEventListener('keydown', function(e) {
					keys[e.key] = true;
				});

				window.addEventListener('keyup', function(e) {
					keys[e.key] = false;
				});
				var scene = new BABYLON.Scene(engine);
				var gravityVector = new BABYLON.Vector3(0, -9.81, 0);
				scene.enablePhysics(gravityVector, new BABYLON.CannonJSPlugin());

				scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.5);
var _xFn = function(t) {var fns = [function(t) {return (Math.pow((1-t),3)*0.0125)+(3*t*Math.pow((1-t),2)*0.06)+(3*Math.pow(t,2)*(1-t)*0.0775)+(Math.pow(t,3)*0.1125)},function(t) {return (Math.pow((1-t),3)*0.1125)+(3*t*Math.pow((1-t),2)*0.1475)+(3*Math.pow(t,2)*(1-t)*0.1375)+(Math.pow(t,3)*0.1975)},function(t) {return (Math.pow((1-t),3)*0.1975)+(3*t*Math.pow((1-t),2)*0.2575)+(3*Math.pow(t,2)*(1-t)*0.235)+(Math.pow(t,3)*0.2725)},function(t) {return (Math.pow((1-t),3)*0.2725)+(3*t*Math.pow((1-t),2)*0.31)+(3*Math.pow(t,2)*(1-t)*0.3225)+(Math.pow(t,3)*0.3775)},function(t) {return (Math.pow((1-t),3)*0.3775)+(3*t*Math.pow((1-t),2)*0.4325)+(3*Math.pow(t,2)*(1-t)*0.41)+(Math.pow(t,3)*0.4425)},function(t) {return (Math.pow((1-t),3)*0.4425)+(3*t*Math.pow((1-t),2)*0.475)+(3*Math.pow(t,2)*(1-t)*0.9525)+(Math.pow(t,3)*0.475)},function(t) {return (Math.pow((1-t),3)*0.475)+(3*t*Math.pow((1-t),2)*-0.0025)+(3*Math.pow(t,2)*(1-t)*0.3775)+(Math.pow(t,3)*0.225)},function(t) {return (Math.pow((1-t),3)*0.225)+(3*t*Math.pow((1-t),2)*0.0725)+(3*Math.pow(t,2)*(1-t)*0.8475)+(Math.pow(t,3)*0.2775)},function(t) {return (Math.pow((1-t),3)*0.2775)+(3*t*Math.pow((1-t),2)*-0.2925)+(3*Math.pow(t,2)*(1-t)*0.9)+(Math.pow(t,3)*0.46)},function(t) {return (Math.pow((1-t),3)*0.46)+(3*t*Math.pow((1-t),2)*0.02)+(3*Math.pow(t,2)*(1-t)*0.8175)+(Math.pow(t,3)*0.365)},function(t) {return (Math.pow((1-t),3)*0.365)+(3*t*Math.pow((1-t),2)*-0.0875)+(3*Math.pow(t,2)*(1-t)*0.68)+(Math.pow(t,3)*0.365)},function(t) {return (Math.pow((1-t),3)*0.365)+(3*t*Math.pow((1-t),2)*0.05)+(3*Math.pow(t,2)*(1-t)*0.5725)+(Math.pow(t,3)*0.21)},function(t) {return (Math.pow((1-t),3)*0.21)+(3*t*Math.pow((1-t),2)*-0.1525)+(3*Math.pow(t,2)*(1-t)*0.165)+(Math.pow(t,3)*0.4975)},function(t) {return (Math.pow((1-t),3)*0.4975)+(3*t*Math.pow((1-t),2)*0.83)+(3*Math.pow(t,2)*(1-t)*0.6475)+(Math.pow(t,3)*0.915)}];var i = Math.max(0,Math.min(13, Math.floor(t * 14)));return fns[i]((t - (i/14)) * 14);};
var _yFn = function(t) {var fns = [function(t) {return (Math.pow((1-t),3)*0.0878125)+(3*t*Math.pow((1-t),2)*0.1653125)+(3*Math.pow(t,2)*(1-t)*0.0078125)+(Math.pow(t,3)*0.1078125)},function(t) {return (Math.pow((1-t),3)*0.1078125)+(3*t*Math.pow((1-t),2)*0.2078125)+(3*Math.pow(t,2)*(1-t)*0.0653125)+(Math.pow(t,3)*0.1053125)},function(t) {return (Math.pow((1-t),3)*0.1053125)+(3*t*Math.pow((1-t),2)*0.1453125)+(3*Math.pow(t,2)*(1-t)*0.0578125)+(Math.pow(t,3)*0.1053125)},function(t) {return (Math.pow((1-t),3)*0.1053125)+(3*t*Math.pow((1-t),2)*0.1528125)+(3*Math.pow(t,2)*(1-t)*0.0453125)+(Math.pow(t,3)*0.1003125)},function(t) {return (Math.pow((1-t),3)*0.1003125)+(3*t*Math.pow((1-t),2)*0.1553125)+(3*Math.pow(t,2)*(1-t)*0.0403125)+(Math.pow(t,3)*0.0903125)},function(t) {return (Math.pow((1-t),3)*0.0903125)+(3*t*Math.pow((1-t),2)*0.1403125)+(3*Math.pow(t,2)*(1-t)*0.3428125)+(Math.pow(t,3)*0.3628125)},function(t) {return (Math.pow((1-t),3)*0.3628125)+(3*t*Math.pow((1-t),2)*0.3828125)+(3*Math.pow(t,2)*(1-t)*0.9803125)+(Math.pow(t,3)*0.5428125)},function(t) {return (Math.pow((1-t),3)*0.5428125)+(3*t*Math.pow((1-t),2)*0.1053125)+(3*Math.pow(t,2)*(1-t)*0.6928125)+(Math.pow(t,3)*0.5353125)},function(t) {return (Math.pow((1-t),3)*0.5353125)+(3*t*Math.pow((1-t),2)*0.3778125)+(3*Math.pow(t,2)*(1-t)*0.4053125)+(Math.pow(t,3)*0.5253125)},function(t) {return (Math.pow((1-t),3)*0.5253125)+(3*t*Math.pow((1-t),2)*0.6453125)+(3*Math.pow(t,2)*(1-t)*0.6228125)+(Math.pow(t,3)*0.6728125)},function(t) {return (Math.pow((1-t),3)*0.6728125)+(3*t*Math.pow((1-t),2)*0.7228125)+(3*Math.pow(t,2)*(1-t)*0.6353125)+(Math.pow(t,3)*0.4703125)},function(t) {return (Math.pow((1-t),3)*0.4703125)+(3*t*Math.pow((1-t),2)*0.3053125)+(3*Math.pow(t,2)*(1-t)*0.6978125)+(Math.pow(t,3)*0.6003125)},function(t) {return (Math.pow((1-t),3)*0.6003125)+(3*t*Math.pow((1-t),2)*0.5028125)+(3*Math.pow(t,2)*(1-t)*0.2878125)+(Math.pow(t,3)*0.7828125)},function(t) {return (Math.pow((1-t),3)*0.7828125)+(3*t*Math.pow((1-t),2)*1.2778125)+(3*Math.pow(t,2)*(1-t)*0.7128125)+(Math.pow(t,3)*0.8628125)}];var i = Math.max(0,Math.min(13, Math.floor(t * 14)));return fns[i]((t - (i/14)) * 14);};
/* START CURVE DATA 
{"start":[5,35.125],"init":[24,66.125],"segments":[{"a":[31,3.125],"b":[45,43.125]},{"a":[55,26.125],"b":[79,42.125]},{"a":[94,23.125],"b":[109,42.125]},{"a":[129,18.125],"b":[151,40.125]},{"a":[164,16.125],"b":[177,36.125]},{"a":[381,137.125],"b":[190,145.125]},{"a":[151,392.125],"b":[90,217.125]},{"a":[339,277.125],"b":[111,214.125]},{"a":[360,162.125],"b":[184,210.125]},{"a":[327,249.125],"b":[146,269.125]},{"a":[272,254.125],"b":[146,188.125]},{"a":[229,279.125],"b":[84,240.125]},{"a":[66,115.125],"b":[199,313.125]},{"a":[259,285.125],"b":[366,345.125]}]}
   END CURVE DATA */
				var xFn = function(t) { return 650 * _xFn(t); }
				var zFn = function(t) { return 650 * _yFn(t); }

				var playerSphere = BABYLON.MeshBuilder.CreateSphere("playerSphere", {
				segments: 12,
				diameter: 4
				}, scene);
				playerSphere.material = new BABYLON.StandardMaterial("playerSphereMaterial", scene);
				playerSphere.material.diffuseTexture = new BABYLON.Texture('resources/BeachBallColor.jpg', scene);
				playerSphere.position = new BABYLON.Vector3(xFn(0), 9, zFn(0));
				playerSphere.physicsImpostor = new BABYLON.PhysicsImpostor(playerSphere, BABYLON.PhysicsImpostor.SphereImpostor, {
				      mass: 1,
				      restitution: 0.9
				  }, scene);

				var camera = new BABYLON.ArcRotateCamera("Camera", 0, (3 * Math.PI) / 8, 20, playerSphere, scene);
				camera.attachControl(canvas, true);

				var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
				var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
				rampAt(xFn, zFn, 0.925, -Math.PI / 4, scene);
				wallAt(xFn, zFn, 0.925, -6.1, scene);
				wallAt(xFn, zFn, 0.925, 6.1, scene);
				scene.registerAfterRender(function() {
				var vel = playerSphere.physicsImpostor.getLinearVelocity();
				playerSphere.physicsImpostor.setLinearVelocity(vel.scale(.98));

				var forward = camera.getFrontPosition(1).subtract(camera.position);
				forward.y = 0;
				forward = forward.normalize().scale(1);

				var backward = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY(Math.PI));

				var left = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY((3 * Math.PI) / 2));

				var right = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY(Math.PI / 2));

				if (keys.w) {
				playerSphere.applyImpulse(forward, playerSphere.getAbsolutePosition());
				}
				if (keys.s) {
				playerSphere.applyImpulse(backward, playerSphere.getAbsolutePosition());
				}
				if (keys.a) {
				playerSphere.applyImpulse(left, playerSphere.getAbsolutePosition());
				}
				if (keys.d) {
				playerSphere.applyImpulse(right, playerSphere.getAbsolutePosition());
				}

				var currentT = tLookup(xFn, zFn, 500, playerSphere.position.x, playerSphere.position.z);
				if (currentT > 0.99) {
win();
}

				if (playerSphere.position.y < -10) {
				lost();
				}
				});

				function drawPoint(x, z, zrot, scene) {
					var point = BABYLON.MeshBuilder.CreateBox('point', {
						width: 10,
						height: 0.5,
						depth: 12
					}, scene);
					point.material = new BABYLON.StandardMaterial("pointMaterial", scene);
					point.material.diffuseColor = new BABYLON.Color3(1, 0, 1);
					point.position = new BABYLON.Vector3(x, 0.1, z);
					point.rotation.y = zrot;
					point.physicsImpostor = new BABYLON.PhysicsImpostor(point, BABYLON.PhysicsImpostor.BoxImpostor, {
					mass: 0,
					restitution: 0.9
					}, scene);
					}

					function drawParametric(xFn, zFn, start, end, res, scene) {
					for (var t = start; t <= end; t += ((end - start) / res)) {
					drawPoint(xFn(t), zFn(t), 0, scene);
					}
					}

			drawParametric(xFn, zFn, 0, 1, 350, scene);

				function tLookup(xFn, zFn, res, x, z) {
				var minT = 0;
				var minDist = Infinity;
				for (var t = 0; t <= 1; t += (1 / res)) {
				var dist = Math.pow(x - xFn(t), 2) + Math.pow(z - zFn(t), 2);
				if (dist < minDist) {
				minDist = dist;
				minT = t;
				}
				}
				return minT;
				}

				function derivAngle(t, xFn, zFn) {
				function derive(f, x) {
				var h = 2.2e-10;
				return (f(x + h) - f(x - h)) / (2 * h);
				}
				return Math.atan2(derive(zFn, t), derive(xFn, t));
				}
				function rampAt(xFn, zFn, t, angle, scene) {
				var ramp = BABYLON.MeshBuilder.CreateBox('ramp', {
				height: 24,
				width: .25,
				depth: 12
				}, scene);
				ramp.material = new BABYLON.StandardMaterial("rampMaterial", scene);
				ramp.material.diffuseColor = new BABYLON.Color3(1, 1, 0);
				ramp.physicsImpostor = new BABYLON.PhysicsImpostor(ramp, BABYLON.PhysicsImpostor.BoxImpostor, {
				mass: 0,
				restitution: 0.9
				}, scene);
				ramp.position = new BABYLON.Vector3(xFn(t), 3.2, zFn(t));

				ramp.rotation.z = angle;
				ramp.rotation.y = -derivAngle(t, xFn, zFn);
				}

				function wallAt(xFn, zFn, t, offset, scene) {
				var wall = BABYLON.MeshBuilder.CreateBox('wall', {
				height: 24,
				width: .25,
				depth: 12
				}, scene);
				angle = -derivAngle(t, xFn, zFn);
				wall.material = new BABYLON.StandardMaterial("wallMaterial", scene);
				wall.material.diffuseColor = new BABYLON.Color3(1, 1, 0);
				wall.physicsImpostor = new BABYLON.PhysicsImpostor(wall, BABYLON.PhysicsImpostor.BoxImpostor, {
				mass: 0,
				restitution: 0.9
				}, scene);
				wall.position = new BABYLON.Vector3(xFn(t) + (offset * Math.sin(angle)), 4, zFn(t) + (offset * Math.cos(angle)));
				wall.rotation.y = angle + (Math.PI / 2);
				return wall;
				}
				engine.runRenderLoop(scene.render.bind(scene));
				window.addEventListener('resize', engine.resize.bind(engine));
				}
				function win(){
				window.location.reload();
				alert("You WIN!");
				}
				function lost(){
				window.location.reload();
				alert("you lose!");
				}
			</script>
			</head>
	<body onload="start()">
		<canvas id="renderCanvas"></canvas>
	</body>
</html>